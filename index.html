<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comparatore Voli Premio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 100%);
  margin: 0;
  padding: 0;
  text-align: center;
}

.container {
  margin-top: 60px;
  background: white;
  padding: 30px;
  border-radius: 16px;
  width: 90%;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}

h1 {
  color: #0f172a;
  font-size: 28px;
  font-weight: 700;
}

input, select {
  padding: 12px;
  margin: 8px;
  width: 220px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button {
  padding: 12px 24px;
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
}

.card {
  background: white;
  margin: 20px auto;
  padding: 22px;
  max-width: 500px;
  border-radius: 14px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.06);
  text-align: left;
}

.section-title {
  margin-top:40px;
  font-size:20px;
  font-weight:600;
}
</style>
</head>

<body>

<div class="container">
<h1>ğŸ¯ Scopri dove i tuoi punti valgono di piÃ¹</h1>

<select id="from">
  <option value="MXP">Milano (MXP)</option>
  <option value="FCO">Roma (FCO)</option>
</select>

<input id="maxMR" placeholder="MR disponibili (es. 40000)">

<br>
<button onclick="searchFlights()">Dove posso andare?</button>

<div id="bestDeal" style="margin-top:30px;"></div>
<div id="results"></div>
</div>

<script>

function searchFlights() {

  const from = document.getElementById("from").value;
  const maxMR = document.getElementById("maxMR").value;

  if (!maxMR) {
    alert("Inserisci i Membership Rewards disponibili");
    return;
  }

  fetch(`/api/search?from=${from}&maxMR=${maxMR}`)
    .then(res => res.json())
    .then(data => {

      const resultsDiv = document.getElementById("results");
      const bestDiv = document.getElementById("bestDeal");

      if (!data.results || data.results.length === 0) {
        resultsDiv.innerHTML = "<h2>Nessuna destinazione trovata</h2>";
        bestDiv.innerHTML = "";
        return;
      }

      const sections = {
        bookable: [],
        almost: [],
        future: []
      };

      data.results.forEach(r => {
        if (r.mrMissing === 0)
          sections.bookable.push(r);
        else if (r.mrMissing <= 20000)
          sections.almost.push(r);
        else
          sections.future.push(r);
      });

      let best;
      if (sections.bookable.length > 0)
        best = sections.bookable[0];
      else if (sections.almost.length > 0)
        best = sections.almost[0];
      else
        best = sections.future[0];

      bestDiv.innerHTML = `
        <div class="card" style="border:2px solid gold;">
          ğŸ”¥ <b>Miglior opportunitÃ  del momento</b><br><br>
          ${best.destination} (${best.region})<br>
          ğŸ”¥ Opportunity Score: ${best.opportunityScore}/100
        </div>
      `;

      let html = "";

      function renderSection(title, list) {

        if (list.length === 0) return;

        html += `<div class="section-title">${title}</div>`;

        list.forEach(r => {

          const avgCash = (parseFloat(r.cashMin) + parseFloat(r.cashMax)) / 2;
          const estimatedSaving = avgCash - parseFloat(r.taxes);

          let ratingLabel = "";
          if (r.opportunityScore >= 75)
            ratingLabel = "ğŸ”¥ <b style='color:green;'>Alta OpportunitÃ </b>";
          else if (r.opportunityScore >= 55)
            ratingLabel = "âš–ï¸ <b style='color:orange;'>Buona OpportunitÃ </b>";
          else
            ratingLabel = "âš ï¸ <b style='color:red;'>Valore Debole</b>";

          html += `
            <div class="card">
              <b>${r.destination}</b> (${r.region})<br><br>

              ğŸ’³ Programma: <b>${r.program}</b><br>
              âœˆï¸ ${r.points.toLocaleString()} punti compagnia<br>
              ğŸ’³ ${r.mrRequired.toLocaleString()} MR richiesti<br><br>

              ğŸ’° Prezzo medio cash: â‚¬${r.cashMin} - â‚¬${r.cashMax}<br>
              ğŸ’¸ Risparmio stimato: â‚¬${estimatedSaving.toFixed(0)}<br><br>

              ğŸ“Š Valore punti: ${r.estimatedValue} cent/punto<br>
              ğŸ”¥ Opportunity Score: ${r.opportunityScore}/100<br>

              ${r.isBestValue ? "ğŸ† <b>Valore piÃ¹ alto tra le opzioni</b><br>" : ""}

              ${r.relativeLoss > 0 
                ? `ğŸ’¸ Rinunci a circa <b>â‚¬${r.relativeLoss}</b> rispetto alla miglior alternativa<br>` 
                : ""}

              ${ratingLabel}<br>

              ${r.mrMissing > 0 
                ? `âš ï¸ Ti mancano ${r.mrMissing.toLocaleString()} MR<br>` 
                : "âœˆï¸ Prenotabile Ora<br>"}
            </div>
          `;
        });
      }

      renderSection("âœˆï¸ Prenotabili Ora", sections.bookable);
      renderSection("âš–ï¸ Quasi Raggiungibili", sections.almost);
      renderSection("ğŸŒ Obiettivi Futuri", sections.future);

      resultsDiv.innerHTML = html;

    })
    .catch(() => {
      document.getElementById("results").innerHTML = "<h2>Errore nella ricerca</h2>";
    });
}

</script>

</body>
</html>
