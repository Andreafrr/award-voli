<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comparatore Voli Premio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 100%);
    margin: 0;
    padding: 0;
    text-align: center;
}

.container {
    margin-top: 60px;
    background: white;
    padding: 30px;
    border-radius: 16px;
    width: 90%;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}

h1 {
    color: #0f172a;
    font-size: 28px;
    font-weight: 700;
}

.section-title {
    font-size: 20px;
    margin-top: 50px;
    font-weight: 600;
}

input, select {
    padding: 12px;
    margin: 8px;
    width: 220px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

button {
    padding: 12px 24px;
    background: #4f46e5;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
}

.card {
    background: white;
    margin: 20px auto;
    padding: 22px;
    border-radius: 14px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    text-align: left;
}
</style>
</head>

<body>

<div class="container">

<h1>ğŸ¯ Scopri dove i tuoi punti valgono di piÃ¹</h1>

<select id="from">
  <option value="MXP">Milano (MXP)</option>
  <option value="FCO">Roma (FCO)</option>
</select>

<input id="maxPoints" placeholder="Punti Amex disponibili">

<br>
<button onclick="searchFlights()">Dove posso andare?</button>

<div id="bestDeal"></div>
<div id="results"></div>

</div>

<script>

function renderCard(r) {

  const avgCash = (parseFloat(r.cashMin) + parseFloat(r.cashMax)) / 2;
  const estimatedSaving = avgCash - parseFloat(r.taxes);

  let badge = "";

  if (r.opportunityScore >= 75)
    badge = "ğŸ”¥ <b style='color:green;'>Alta OpportunitÃ </b>";
  else if (r.opportunityScore >= 50)
    badge = "âš–ï¸ <b style='color:orange;'>Buona OpportunitÃ </b>";
  else
    badge = "âš ï¸ <b style='color:red;'>Valore Debole</b>";

  return `
    <div class="card">
      <b>${r.destination}</b> (${r.region})<br><br>
      ğŸ’³ Programma: <b>${r.program}</b><br>
      âœˆï¸ ${r.points.toLocaleString()} punti compagnia<br>
      ğŸ’³ ${r.mrRequired.toLocaleString()} MR richiesti<br><br>
      ğŸ’° Prezzo medio cash: â‚¬${r.cashMin} - â‚¬${r.cashMax}<br>
      ğŸ’¸ Risparmio stimato: <b>â‚¬${estimatedSaving.toFixed(0)}</b><br><br>
      ğŸ“Š Valore punti: ${r.estimatedValue} cent/punto<br>
      ğŸ”¥ Opportunity Score: <b>${r.opportunityScore}/100</b><br>
      ${badge}<br>
      ${r.mrMissing > 0 ? `âš ï¸ Ti mancano ${r.mrMissing.toLocaleString()} MR<br>` : ""}
    </div>
  `;
}

function searchFlights() {

  const from = document.getElementById("from").value;
  const maxPoints = document.getElementById("maxPoints").value;

  if (!maxPoints) {
    alert("Inserisci i punti Amex disponibili");
    return;
  }

  fetch(`/api/search?from=${from}&maxMR=${maxPoints}`)
    .then(response => response.json())
    .then(data => {

      const sections = data.sections;
      const resultsDiv = document.getElementById("results");
      const bestDiv = document.getElementById("bestDeal");

      resultsDiv.innerHTML = "";
      bestDiv.innerHTML = "";

      const allRoutes = [
        ...sections.bookable,
        ...sections.almost,
        ...sections.future
      ];

      if (allRoutes.length === 0) {
        resultsDiv.innerHTML = "<h2>Nessuna destinazione trovata.</h2>";
        return;
      }

      // ğŸ”¥ Best Deal SOLO tra prenotabili
      let best;

      if (sections.bookable.length > 0)
        best = sections.bookable[0];
      else if (sections.almost.length > 0)
        best = sections.almost[0];
      else
        best = sections.future[0];

      bestDiv.innerHTML = `
        <div class="card" style="border:2px solid gold;">
          ğŸ”¥ <b>Miglior opportunitÃ  del momento</b><br><br>
          ${best.destination} (${best.region})<br>
          ğŸ”¥ Opportunity Score: <b>${best.opportunityScore}/100</b>
        </div>
      `;

      if (sections.bookable.length > 0) {
        resultsDiv.innerHTML += `<div class="section-title">âœˆï¸ Prenotabili Ora</div>`;
        sections.bookable.forEach(r => {
          resultsDiv.innerHTML += renderCard(r);
        });
      }

      if (sections.almost.length > 0) {
        resultsDiv.innerHTML += `<div class="section-title">âš–ï¸ Quasi Raggiungibili</div>`;
        sections.almost.forEach(r => {
          resultsDiv.innerHTML += renderCard(r);
        });
      }

      if (sections.future.length > 0) {
        resultsDiv.innerHTML += `<div class="section-title">ğŸŒ Obiettivi Futuri</div>`;
        sections.future.forEach(r => {
          resultsDiv.innerHTML += renderCard(r);
        });
      }

    })
    .catch(error => {
      console.error(error);
      document.getElementById("results").innerHTML = "<h2>Errore nella ricerca</h2>";
    });
}

</script>

</body>
</html>
